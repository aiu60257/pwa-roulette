<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>インチキルーレット</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    canvas { margin: 20px auto; display: block; }
    #result { font-size: 20px; margin-top: 10px; font-weight: bold; }
    .hidden { display: none; }
    #secretBtn {
      position: fixed;
      right: 5px; bottom: 5px;
      width: 30px; height: 30px;
      background: white; border: none;
      opacity: 0.05; /* 見えないボタン */
    }
  </style>
</head>
<body>
  <h2>インチキルーレット</h2>
  <canvas id="wheel" width="400" height="400"></canvas><br>
  <button id="spin">回す！</button>
  <div id="result"></div>

  <!-- 表向き設定フォーム -->
  <h3>表向きの設定</h3>
  <div id="settings"></div>
  
  <!-- 本当の確率設定フォーム（隠し） -->
  <div id="secretSettings" class="hidden">
    <h3>本当の確率</h3>
    <div id="secretConfig"></div>
  </div>

  <button id="secretBtn"></button>

  <script>
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    const size = canvas.width;
    const radius = size / 2;
    let currentAngle = 0;

    // 初期項目
    let items = [
      { label: "A", publicProb: 25, secretProb: 25 },
      { label: "B", publicProb: 25, secretProb: 25 },
      { label: "C", publicProb: 25, secretProb: 25 },
      { label: "D", publicProb: 25, secretProb: 25 }
    ];

    let useSecret = false; // 裏確率を使うかどうか

    // ホイール描画
    function drawWheel() {
      ctx.clearRect(0, 0, size, size);
      const probs = items.map(it => useSecret ? it.secretProb : it.publicProb);
      const total = probs.reduce((a, b) => a + b, 0);
      let startAngle = currentAngle;
      for (let i = 0; i < items.length; i++) {
        const angle = (probs[i] / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, startAngle, startAngle + angle);
        ctx.fillStyle = `hsl(${i * 360 / items.length}, 80%, 60%)`;
        ctx.fill();
        ctx.stroke();
        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(startAngle + angle / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#000";
        ctx.font = "16px sans-serif";
        ctx.fillText(items[i].label, radius - 10, 5);
        ctx.restore();
        startAngle += angle;
      }
      // インジケータ
      ctx.fillStyle = "black";
      ctx.beginPath();
      ctx.moveTo(radius, 0);
      ctx.lineTo(radius - 10, 20);
      ctx.lineTo(radius + 10, 20);
      ctx.closePath();
      ctx.fill();
    }

    // 当選アイテムを確率で選択
    function pickItem() {
      const probs = items.map(it => useSecret ? it.secretProb : it.publicProb);
      const total = probs.reduce((a, b) => a + b, 0);
      let r = Math.random() * total;
      for (let i = 0; i < items.length; i++) {
        if (r < probs[i]) return i;
        r -= probs[i];
      }
      return items.length - 1;
    }

    // スピン処理
    function spinWheel() {
      const winnerIndex = pickItem();
      const probs = items.map(it => useSecret ? it.secretProb : it.publicProb);
      const total = probs.reduce((a, b) => a + b, 0);

      // 当選角度範囲を計算
      let startAngle = 0;
      for (let i = 0; i < winnerIndex; i++) {
        startAngle += (probs[i] / total) * Math.PI * 2;
      }
      let endAngle = startAngle + (probs[winnerIndex] / total) * Math.PI * 2;

      // 真上(= -90°)に止める → ランダムにその範囲の角度を選ぶ
      const targetAngle = -Math.PI / 2 - (startAngle + Math.random() * (endAngle - startAngle));

      // 複数周回してから止める
      const spins = 5; 
      const finalAngle = targetAngle + Math.PI * 2 * spins;

      let duration = 3000; // 3秒
      let start = null;

      function animate(timestamp) {
        if (!start) start = timestamp;
        let progress = (timestamp - start) / duration;
        if (progress > 1) progress = 1;
        const ease = 1 - Math.pow(1 - progress, 3); // イージング（減速）
        currentAngle = currentAngle * (1 - ease) + finalAngle * ease;
        drawWheel();
        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          document.getElementById("result").innerText = "結果: " + items[winnerIndex].label;
        }
      }
      requestAnimationFrame(animate);
    }

    // 設定フォーム生成
    function renderSettings() {
      const settingsDiv = document.getElementById("settings");
      const secretDiv = document.getElementById("secretConfig");
      settingsDiv.innerHTML = "";
      secretDiv.innerHTML = "";
      items.forEach((it, idx) => {
        settingsDiv.innerHTML += `
          <div>
            <input value="${it.label}" onchange="items[${idx}].label=this.value">
            表確率: <input type="number" value="${it.publicProb}" onchange="items[${idx}].publicProb=+this.value"> %
          </div>`;
        secretDiv.innerHTML += `
          <div>
            ${it.label} 本当: <input type="number" value="${it.secretProb}" onchange="items[${idx}].secretProb=+this.value"> %
          </div>`;
      });
    }

    // 隠しボタン
    document.getElementById("secretBtn").onclick = () => {
      const pw = prompt("パスワードを入力:");
      if (pw === "8888") {
        document.getElementById("secretSettings").classList.toggle("hidden");
        useSecret = !useSecret;
        drawWheel();
      }
    };

    document.getElementById("spin").onclick = () => {
      spinWheel();
    };

    renderSettings();
    drawWheel();
  </script>
</body>
</html>
