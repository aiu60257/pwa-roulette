<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>インチキ可能ルーレット</title>
<style>
  body { text-align:center; font-family:sans-serif; }
  canvas { margin-top:20px; }
  #result { margin-top:20px; font-size:20px; font-weight:bold; }
  #hiddenBtn {
    position:fixed; right:0; bottom:0;
    width:40px; height:40px;
    background:white; border:none; opacity:0.1;
  }
</style>
</head>
<body>
<h1>ルーレット</h1>
<canvas id="wheel" width="300" height="300"></canvas><br>
<button onclick="spin()">スタート</button>
<div id="result"></div>

<!-- 隠しボタン -->
<button id="hiddenBtn" onclick="showAdmin()"></button>

<script>
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const resultDiv = document.getElementById("result");

let items = ["A賞","B賞","C賞","ハズレ"];
let probs = [0.25,0.25,0.25,0.25];  // 表向き確率
let realProbs = [...probs];          // 本当の確率
let useReal = false;

let angle = 0;
let spinning = false;

// ルーレット描画
function drawWheel() {
  const total = probs.reduce((a,b)=>a+b,0);
  let start = 0;
  items.forEach((item,i)=>{
    const slice = probs[i] / total * 2*Math.PI;
    ctx.beginPath();
    ctx.moveTo(150,150);
    ctx.arc(150,150,150,start,start+slice);
    ctx.fillStyle = `hsl(${i*90},80%,60%)`;
    ctx.fill();
    ctx.stroke();
    ctx.save();
    ctx.translate(150,150);
    ctx.rotate(start+slice/2);
    ctx.fillStyle="black";
    ctx.fillText(item,60,5);
    ctx.restore();
    start += slice;
  });
  // インジケータ ▼
  ctx.fillStyle="black";
  ctx.beginPath();
  ctx.moveTo(145,0);
  ctx.lineTo(155,0);
  ctx.lineTo(150,20);
  ctx.fill();
}
drawWheel();

// 抽選開始
function spin(){
  if(spinning) return;
  spinning=true;
  const chosen = pickItem();
  let targetAngle = getTargetAngle(chosen);
  let rotate = angle + 10*Math.PI + targetAngle; // 複数回転＋狙い角度
  let start = null;

  function animate(ts){
    if(!start) start=ts;
    let progress=(ts-start)/3000; // 3秒
    if(progress>=1){
      angle = rotate % (2*Math.PI);
      spinning=false;
      resultDiv.textContent="結果: "+items[chosen];
      return;
    }
    angle = (angle + (rotate-angle)*progress) % (2*Math.PI);
    redraw();
    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
}

// アイテム選択（インチキ対応）
function pickItem(){
  let p = useReal ? realProbs : probs;
  let r=Math.random();
  let cum=0;
  for(let i=0;i<p.length;i++){
    cum+=p[i];
    if(r<cum) return i;
  }
  return p.length-1;
}

// 結果を真上に揃える角度計算
function getTargetAngle(index){
  const total = probs.reduce((a,b)=>a+b,0);
  let start=0;
  for(let i=0;i<index;i++) start+=probs[i]/total*2*Math.PI;
  let slice=probs[index]/total*2*Math.PI;
  return (2*Math.PI - (start+slice/2)) % (2*Math.PI);
}

// 再描画
function redraw(){
  ctx.clearRect(0,0,300,300);
  ctx.save();
  ctx.translate(150,150);
  ctx.rotate(angle);
  ctx.translate(-150,-150);
  drawWheel();
  ctx.restore();
}

// 管理者機能
function showAdmin(){
  let pass = prompt("パスワードを入力してください");
  if(pass==="8888"){
    let input = prompt("本当の確率(カンマ区切り, 合計1):", realProbs.join(","));
    if(input){
      realProbs = input.split(",").map(Number);
      useReal = true;
      alert("インチキ確率が設定されました");
    }
  }
}
</script>
</body>
</html>
