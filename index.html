<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>インチキルーレット</title>
  <style>
    body { text-align: center; font-family: sans-serif; }
    canvas { border: 2px solid black; margin: 20px; }
    #indicator { font-size: 40px; margin-top: -30px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>インチキルーレット</h2>
  <div id="indicator">▼</div>
  <canvas id="wheel" width="400" height="400"></canvas>
  <br>
  <button onclick="spin()">回す！</button>
  <p id="result"></p>

  <h3>項目設定</h3>
  <textarea id="items" rows="4" cols="40">A,25;B,25;C,25;D,25</textarea>
  <p>フォーマット: 項目名,確率(%) ; 区切り</p>

  <button onclick="unlock()">主催者設定（パスワード必要）</button>
  <div id="admin" class="hidden">
    <h3>本当の確率設定</h3>
    <textarea id="trueItems" rows="4" cols="40">A,25;B,25;C,25;D,25</textarea>
    <p>この確率が実際に使用されます</p>
  </div>

  <script>
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    let angle = 0;
    let spinning = false;
    let items = [];
    let trueItems = [];

    function parseInput(text) {
      return text.split(";").map(x=>{
        let [name, prob] = x.split(",");
        return {name:name.trim(), prob:parseFloat(prob)};
      });
    }

    function drawWheel(list) {
      ctx.clearRect(0,0,400,400);
      let total = list.reduce((a,b)=>a+b.prob,0);
      let start = 0;
      list.forEach((item,i)=>{
        let slice = (item.prob/total)*2*Math.PI;
        ctx.beginPath();
        ctx.moveTo(200,200);
        ctx.arc(200,200,180,start,start+slice);
        ctx.fillStyle = `hsl(${i*60},70%,60%)`;
        ctx.fill();
        ctx.stroke();
        ctx.save();
        ctx.translate(200,200);
        ctx.rotate(start+slice/2);
        ctx.textAlign="right";
        ctx.fillStyle="black";
        ctx.font="16px sans-serif";
        ctx.fillText(item.name,170,5);
        ctx.restore();
        start += slice;
      });
    }

    function spin() {
      if(spinning) return;
      spinning = true;

      items = parseInput(document.getElementById("items").value);
      trueItems = document.getElementById("admin").classList.contains("hidden") ? items : parseInput(document.getElementById("trueItems").value);

      let total = trueItems.reduce((a,b)=>a+b.prob,0);
      let r = Math.random()*total;
      let sum=0, selected=null;
      for(let it of trueItems){
        sum += it.prob;
        if(r<=sum){ selected=it; break; }
      }

      let index = trueItems.findIndex(i=>i.name===selected.name);
      let startAngle=0;
      for(let i=0;i<index;i++){
        startAngle += (trueItems[i].prob/total)*2*Math.PI;
      }
      let slice = (selected.prob/total)*2*Math.PI;
      let targetAngle = startAngle + slice/2;

      // インジケータ(真上)に合わせる。少しブレ追加。
      let stopAngle = (3*Math.PI/2 - targetAngle) + (Math.random()*0.05 - 0.025);

      let spinAngle = stopAngle + Math.PI*8; // 何回転かして止まる
      let duration = 3000;
      let startTime = null;

      function animate(t){
        if(!startTime) startTime=t;
        let progress = (t-startTime)/duration;
        if(progress<1){
          angle = spinAngle*easeOut(progress);
          drawRotated();
          requestAnimationFrame(animate);
        } else {
          angle = stopAngle;
          drawRotated();
          spinning=false;
          document.getElementById("result").innerText = "結果: "+selected.name;
        }
      }
      requestAnimationFrame(animate);
    }

    function easeOut(t){ return 1-Math.pow(1-t,3); }

    function drawRotated(){
      ctx.save();
      ctx.translate(200,200);
      ctx.rotate(angle);
      ctx.translate(-200,-200);
      drawWheel(items);
      ctx.restore();
    }

    function unlock(){
      let pw = prompt("パスワードを入力してください:");
      if(pw==="8888"){
        document.getElementById("admin").classList.remove("hidden");
      } else {
        alert("パスワードが違います");
      }
    }

    // 初期描画
    items = parseInput(document.getElementById("items").value);
    drawWheel(items);
  </script>
</body>
</html>
