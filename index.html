<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>インチキルーレット</title>
<style>
  body { text-align: center; font-family: sans-serif; }
  canvas { margin-top: 20px; }
  #indicator { font-size: 40px; }
  #result { margin-top: 20px; font-size: 20px; font-weight: bold; }
  #adminPanel { display: none; border: 1px solid #aaa; padding: 10px; margin-top: 20px; }
</style>
</head>
<body>
  <h1>インチキルーレット</h1>
  <div id="indicator">▼</div>
  <canvas id="roulette" width="300" height="300"></canvas><br>
  <button onclick="spin()">回す！</button>
  <div id="result"></div>

  <!-- 裏設定呼び出し -->
  <input type="password" id="password" placeholder="パスワード">
  <button onclick="checkPassword()">設定モード</button>

  <!-- 裏設定パネル -->
  <div id="adminPanel">
    <h3>裏設定</h3>
    <label>分割数: <input type="number" id="segments" value="4"></label><br>
    <textarea id="labels" rows="4" cols="30">A,B,C,D</textarea><br>
    <textarea id="trueProb" rows="4" cols="30">25,25,25,25</textarea><br>
    <textarea id="fakeProb" rows="4" cols="30">40,20,20,20</textarea><br>
    <button onclick="applySettings()">設定を反映</button>
  </div>

<script>
const canvas = document.getElementById("roulette");
const ctx = canvas.getContext("2d");
const resultDiv = document.getElementById("result");

let labels = ["A","B","C","D"];
let trueProb = [25,25,25,25];
let fakeProb = [40,20,20,20];
let useFake = false;

function drawRoulette(){
  const seg = labels.length;
  const angle = 2 * Math.PI / seg;
  ctx.clearRect(0,0,300,300);
  for(let i=0;i<seg;i++){
    ctx.beginPath();
    ctx.moveTo(150,150);
    ctx.arc(150,150,140, i*angle, (i+1)*angle);
    ctx.fillStyle = i%2==0 ? "#f99" : "#99f";
    ctx.fill();
    ctx.stroke();
    ctx.save();
    ctx.translate(150,150);
    ctx.rotate(i*angle+angle/2);
    ctx.textAlign="right";
    ctx.fillStyle="black";
    ctx.font="16px sans-serif";
    ctx.fillText(labels[i],120,5);
    ctx.restore();
  }
}
drawRoulette();

function weightedRandom(probabilities){
  let sum=0, r=Math.random()*100;
  for(let i=0;i<probabilities.length;i++){
    sum+=probabilities[i];
    if(r<sum) return i;
  }
  return probabilities.length-1;
}

function spin(){
  const probs = useFake ? fakeProb : trueProb;
  const index = weightedRandom(probs);
  const seg = labels.length;
  const anglePerSeg = 2*Math.PI/seg;
  
  // 中心からランダムに±5度ズラす
  const offset = (Math.random()-0.5)*(Math.PI/36);

  const stopAngle = (3*Math.PI/2) - (index*anglePerSeg + anglePerSeg/2) + offset;

  let currentAngle=0, spins = Math.floor(Math.random()*3)+5; // 5〜7回転
  let totalRotation = spins*2*Math.PI + stopAngle;

  let start=null;
  function animate(t){
    if(!start) start=t;
    const progress = Math.min((t-start)/3000,1);
    const ease = 1-Math.pow(1-progress,3);
    const angle = ease*totalRotation;
    ctx.save();
    ctx.translate(150,150);
    ctx.rotate(angle);
    ctx.translate(-150,-150);
    drawRoulette();
    ctx.restore();
    if(progress<1){
      requestAnimationFrame(animate);
    }else{
      resultDiv.textContent="結果: "+labels[index];
    }
  }
  requestAnimationFrame(animate);
}

// パスワード判定
function checkPassword(){
  if(document.getElementById("password").value==="8888"){
    document.getElementById("adminPanel").style.display="block";
  }
}

// 設定反映
function applySettings(){
  const seg = parseInt(document.getElementById("segments").value);
  labels = document.getElementById("labels").value.split(",");
  trueProb = document.getElementById("trueProb").value.split(",").map(Number);
  fakeProb = document.getElementById("fakeProb").value.split(",").map(Number);
  drawRoulette();
}
</script>
</body>
</html>
