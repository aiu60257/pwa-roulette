<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>æŠ½é¸ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆiPhoneç”¨ï¼‰</title>

<!-- PWAã£ã½ãè¦‹ã›ã‚‹ãŸã‚ã®è¨­å®šï¼ˆiOSå‘ã‘metaã‚‚å…¥ã‚Œã¦ã‚ã‚Šã¾ã™ï¼‰ -->
<link rel="manifest" href="./manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
  body{font-family: -apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial;margin:18px;text-align:center;color:#222}
  h1{font-size:18px;margin-bottom:6px}
  .stage{position:relative; width:320px; height:320px; margin:12px auto;}
  #wheel{
    width:100%; height:100%; border-radius:50%;
    box-shadow:0 6px 18px rgba(0,0,0,0.18);
    transform: rotate(0deg);
    transition: transform 0s;
    display:block;
    background: lightgray;
  }
  #pointer{
    position:absolute; left:50%; transform:translateX(-50%); top:-12px;
    font-size:26px; pointer-events:none;
  }
  textarea{width:100%; max-width:480px; height:110px; padding:8px; box-sizing:border-box; font-size:14px}
  .controls{margin-top:10px}
  button{padding:10px 14px; font-size:16px; margin:0 6px; border-radius:8px; border:0; background:#0a84ff;color:white}
  #result{margin-top:12px; font-weight:700; font-size:18px}
  #history{margin-top:8px; text-align:left; max-width:480px; margin-left:auto; margin-right:auto; padding:6px; background:#fafafa;border-radius:8px; font-size:13px}
  label.small{display:block; text-align:left; max-width:480px; margin:8px auto 4px; font-size:13px;color:#555}
</style>
</head>
<body>
  <h1>æŠ½é¸ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆiPhoneå°‚ç”¨æ‰‹é †ï¼‰</h1>

  <div class="stage">
    <div id="pointer">â–²</div>
    <div id="wheel" aria-hidden="true"></div>
  </div>

  <label class="small">é …ç›®ï¼ˆ1è¡Œã«1ã¤ã€é‡ã¿ã‚’ä½¿ã†å ´åˆã¯ã€Œåå‰:é‡ã¿ã€ï¼‰ä¾‹ï¼‰å½“ãŸã‚Š:1 ã¾ãŸã¯ ãƒã‚ºãƒ¬</label>
  <textarea id="itemInput">å½“ãŸã‚Š:1
ãƒã‚ºãƒ¬:3
ãƒœãƒ¼ãƒŠã‚¹:1</textarea>

  <div class="controls">
    <button id="saveBtn">é …ç›®ã‚’ä¿å­˜</button>
    <button id="spinBtn">ã‚¹ãƒ”ãƒ³ï¼</button>
    <button id="clearHistoryBtn" style="background:#ff3b30">å±¥æ­´ã‚¯ãƒªã‚¢</button>
  </div>

  <div id="result"></div>

  <h3 style="font-size:15px;margin-top:16px">å±¥æ­´</h3>
  <div id="history">ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>

<script>
/* ---- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚­ãƒ¼ ---- */
const KEY_ITEMS = 'pwa_roulette_items_v1';
const KEY_HISTORY = 'pwa_roulette_history_v1';

/* ---- è¦ç´  ---- */
const wheel = document.getElementById('wheel');
const textarea = document.getElementById('itemInput');
const saveBtn = document.getElementById('saveBtn');
const spinBtn = document.getElementById('spinBtn');
const resultDiv = document.getElementById('result');
const historyDiv = document.getElementById('history');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');

/* ---- è‰²ã®é…åˆ—ï¼ˆå¿…è¦ãªã‚‰å¢—ã‚„ã—ã¦ãã ã•ã„ï¼‰ ---- */
const COLORS = ['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#AF7CE5','#FF9671','#FFB3C1','#9BE3DE'];

/* ---- èª­ã¿è¾¼ã¿æ™‚ï¼šä¿å­˜æ¸ˆã¿é …ç›®ã‚’èª­ã¿è¾¼ã‚€ ---- */
function loadItems(){
  const raw = localStorage.getItem(KEY_ITEMS);
  if(raw){ textarea.value = raw; }
}
function loadHistory(){
  const raw = localStorage.getItem(KEY_HISTORY);
  if(!raw){ historyDiv.textContent = 'ï¼ˆã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰'; return; }
  const arr = JSON.parse(raw).slice().reverse();
  historyDiv.innerHTML = arr.map(h => `<div style="padding:6px 0;border-bottom:1px solid #eee">${h.time} â€” ${h.choice}</div>`).join('');
}

/* ---- ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦ [{name, weight}] ã«ã™ã‚‹ ---- */
function parseItems(text){
  const lines = text.split('\n').map(s => s.trim()).filter(Boolean);
  const arr = lines.map(line => {
    const parts = line.split(':');
    if(parts.length>=2){
      const w = parseFloat(parts.slice(1).join(':')) || 1;
      return { name: parts[0].trim(), weight: Math.max(0,w) };
    }else{
      return { name: line, weight: 1 };
    }
  }).filter(x => x.weight>0 && x.name);
  return arr.length ? arr : [{name:'ç©ºæ¬„', weight:1}];
}

/* ---- ãƒ›ã‚¤ãƒ¼ãƒ«ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯ã‚’ä½œã‚‹ ---- */
function renderWheel(items){
  const total = items.reduce((s,i)=>s+i.weight,0);
  let cur = 0;
  const stops = items.map((it, idx) => {
    const start = cur;
    const deg = it.weight/total*360;
    cur += deg;
    const color = COLORS[idx % COLORS.length];
    // conic-gradient ã®å„åŒºé–“ã¯ "color startdeg enddeg"
    return `${color} ${start}deg ${cur}deg`;
  });
  wheel.style.background = `conic-gradient(${stops.join(', ')})`;
}

/* ---- å®Ÿéš›ã®æŠ½é¸ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ---- */
let currentRotation = 0;

function spinOnce(){
  const items = parseItems(textarea.value);
  const total = items.reduce((s,i)=>s+i.weight,0);
  // ãƒ©ãƒ³ãƒ€ãƒ ã«å½“ãŸã‚Šã‚’é¸ã¶ï¼ˆé‡ã¿ä»˜ãï¼‰
  let r = Math.random()*total;
  let idx = 0, cum = 0;
  for(let i=0;i<items.length;i++){
    cum += items[i].weight;
    if(r <= cum){ idx = i; break; }
  }
  // ãã®åŒºé–“ã®è§’åº¦ç¯„å›²ã‚’æ±‚ã‚ã‚‹
  let start = 0;
  for(let i=0;i<idx;i++) start += items[i].weight/total*360;
  const span = items[idx].weight/total*360;
  const center = start + span/2; // ä¸­å¿ƒè§’ï¼ˆdegï¼‰--- 0deg ã¯ä¸Šï¼ˆâ–²ã®ä½ç½®ï¼‰
  // ç›®å°ï¼ˆâ–²ï¼‰ã®ä½ç½®ã«ãã‚‹ã‚ˆã†ã«å›è»¢ã•ã›ã‚‹ï¼ˆ360 - centerï¼‰
  const extraSpins = 3 + Math.floor(Math.random()*3); // 3ã€œ5å›è»¢ã®ãƒ©ãƒ³ãƒ€ãƒ 
  const final = currentRotation + extraSpins*360 + (360 - center);
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  wheel.style.transition = 'transform 4s cubic-bezier(0.33,1,0.68,1)';
  wheel.style.transform = `rotate(${final}deg)`;
  currentRotation = final % 360;
  spinBtn.disabled = true;
  // çµ‚äº†å¾Œã®å‡¦ç†ï¼ˆ4.2så¾Œï¼‰
  setTimeout(()=>{
    const choice = items[idx].name;
    resultDiv.textContent = `å½“é¸ï¼š ${choice} ğŸ‰`;
    saveHistory(choice);
    loadHistory();
    spinBtn.disabled = false;
    // ã•ã‚‰ã«ã‚†ã‚‹ãæˆ»ã‚‹ï¼ˆä»»æ„ï¼‰ â€” ä»Šã¯ãã®ã¾ã¾åœæ­¢
  }, 4200);
}

/* ---- å±¥æ­´ä¿å­˜ ---- */
function saveHistory(choice){
  const raw = localStorage.getItem(KEY_HISTORY);
  const arr = raw ? JSON.parse(raw) : [];
  arr.push({ choice, time: (new Date()).toLocaleString() });
  // å±¥æ­´ã¯100ä»¶ã¾ã§ã«ã—ã¦ãŠã
  while(arr.length>100) arr.shift();
  localStorage.setItem(KEY_HISTORY, JSON.stringify(arr));
}

/* ---- UIã‚¤ãƒ™ãƒ³ãƒˆ ---- */
saveBtn.addEventListener('click', ()=>{
  localStorage.setItem(KEY_ITEMS, textarea.value.trim());
  renderWheel(parseItems(textarea.value));
  alert('é …ç›®ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰');
});
spinBtn.addEventListener('click', spinOnce);
clearHistoryBtn.addEventListener('click', ()=>{
  if(confirm('å±¥æ­´ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')){ localStorage.removeItem(KEY_HISTORY); loadHistory(); }
});

/* ---- åˆæœŸæç”» ---- */
loadItems();
const initialItems = parseItems(textarea.value);
renderWheel(initialItems);
loadHistory();

/* ---- ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰ãƒ›ã‚¤ãƒ¼ãƒ«ã‚’æ­¢ã‚ã‚‹ç­‰ã®ä½™åœ°ã¯æ®‹ã—ã¦ã„ã¾ã™ ---- */
</script>
</body>
</html>
